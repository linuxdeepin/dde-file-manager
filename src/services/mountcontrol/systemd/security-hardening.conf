# SPDX-FileCopyrightText: 2025 UnionTech Software Technology Co., Ltd.
#
# SPDX-License-Identifier: GPL-3.0-or-later

# Security hardening for MountControl service
# This drop-in configuration adds security restrictions to the service
# managed by deepin-service-manager
#
# Business requirements:
# - Mount/unmount filesystems (requires CAP_SYS_ADMIN)
# - Access block devices (/dev/*)
# - Read mount configuration (/etc/fstab, /proc/mounts)
# - Network access for network filesystems (NFS, SMB)
# - Access removable media and external drives

[Service]
# System Protection
ProtectSystem=full
ProtectHome=true
ProtectProc=invisible

# Process Isolation
PrivateTmp=true
# Note: PrivateDevices is disabled in global override config
# to allow access to block devices needed for mounting
ProtectKernelTunables=true
ProtectKernelModules=false

# Security Options
NoNewPrivileges=true
MemoryDenyWriteExecute=true
RestrictSUIDSGID=true

# Access Control - Block sensitive files
# Note: /etc/fstab is NOT blocked as mount operations need to read it
InaccessiblePaths=-/etc/shadow
InaccessiblePaths=-/etc/NetworkManager/system-connections/
InaccessiblePaths=-/etc/pam.d/
InaccessiblePaths=-/etc/security/
InaccessiblePaths=-/etc/selinux/
InaccessiblePaths=-/etc/deepin-elf-verify/
InaccessiblePaths=-/etc/filearmor.d/
InaccessiblePaths=-/etc/crypttab
InaccessiblePaths=-/sysroot/ostree/repo/
InaccessiblePaths=-/persistent/ostree/repo/
InaccessiblePaths=-/usr/share/uadp
InaccessiblePaths=-/etc/sudoers
InaccessiblePaths=-/etc/sudoers.d
InaccessiblePaths=-/root
InaccessiblePaths=-/var/log
InaccessiblePaths=-/var/cache

# Device Access
# MountControl needs access to block devices for mounting filesystems
# DevicePolicy=auto (default) - allows access to /dev with appropriate permissions
# This is enabled by the global override config: PrivateDevices=no

# Network Access
# MountControl may need network access for network filesystems (NFS, SMB, etc.)
# This is enabled by the global override config: PrivateNetwork=no

# Performance
OOMScoreAdjust=-200
Nice=-5

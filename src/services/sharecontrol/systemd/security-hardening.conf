# SPDX-FileCopyrightText: 2025 UnionTech Software Technology Co., Ltd.
#
# SPDX-License-Identifier: GPL-3.0-or-later

# Security hardening for UserShareManager service
# This drop-in configuration adds security restrictions to the service
# managed by deepin-service-manager
#
# Business requirements:
# - Manage user file shares (SMB/Samba)
# - Access Samba configuration files
# - Network access for SMB protocol
# - Modify user share configurations
# - Handle file descriptors for password credentials

[Service]
# System Protection
ProtectSystem=full
ProtectHome=true
ProtectProc=invisible

# Process Isolation
PrivateTmp=true
# Note: PrivateDevices is disabled in global override config
# UserShareManager doesn't need device access, but this is consistent
# with other file manager services
ProtectKernelTunables=true
ProtectKernelModules=false

# Security Options
NoNewPrivileges=true
MemoryDenyWriteExecute=true
RestrictSUIDSGID=true

# Access Control - Block sensitive files
# Note: We DON'T block paths that UserShareManager needs:
# - /etc/samba/ - Samba configuration (if it exists there)
# - /var/lib/samba/ - Samba state data
InaccessiblePaths=-/etc/shadow
InaccessiblePaths=-/etc/NetworkManager/system-connections/
InaccessiblePaths=-/etc/pam.d/
InaccessiblePaths=-/etc/security/
InaccessiblePaths=-/etc/selinux/
InaccessiblePaths=-/etc/deepin-elf-verify/
InaccessiblePaths=-/etc/filearmor.d/
InaccessiblePaths=-/etc/crypttab
InaccessiblePaths=-/etc/fstab
InaccessiblePaths=-/sysroot/ostree/repo/
InaccessiblePaths=-/persistent/ostree/repo/
InaccessiblePaths=-/usr/share/uadp
InaccessiblePaths=-/etc/sudoers
InaccessiblePaths=-/etc/sudoers.d
InaccessiblePaths=-/root
InaccessiblePaths=-/var/log
InaccessiblePaths=-/var/cache

# Network Access
# UserShareManager requires network access for SMB operations
# This is enabled by the global override config: PrivateNetwork=no

# File Descriptor Access
# SetUserSharePassword method receives credentials via file descriptor
# No special configuration needed - this works with default systemd settings

# Performance
OOMScoreAdjust=-200
Nice=-5

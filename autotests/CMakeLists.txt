# autotests/CMakeLists.txt - DDEæ–‡ä»¶ç®¡ç†å™¨æ–°æµ‹è¯•æ¶æ„æ ¹é…ç½®
# åŸºäºé›¶ä¾µå…¥è‡ªåŠ¨æ–‡ä»¶å‘ç°çš„ç°ä»£åŒ–æµ‹è¯•åŸºç¡€è®¾æ–½

cmake_minimum_required(VERSION 3.16)

# è®¾ç½®é¡¹ç›®ä¿¡æ¯
project(dfm-autotests
    VERSION 1.0.0
    DESCRIPTION "DDE File Manager Test Infrastructure"
    LANGUAGES CXX
)

# è®¾ç½®C++æ ‡å‡†
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# å¯ç”¨å¯¼å‡ºç¼–è¯‘å‘½ä»¤ï¼ˆç”¨äºIDEæ”¯æŒï¼‰
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

# è®¾ç½®æºä»£ç æ ¹ç›®å½•
set(DFM_SOURCE_DIR "${CMAKE_CURRENT_SOURCE_DIR}/..")

message(STATUS "========================================")
message(STATUS "DDEæ–‡ä»¶ç®¡ç†å™¨æµ‹è¯•ç³»ç»Ÿ v${PROJECT_VERSION}")
message(STATUS "========================================")
message(STATUS "æºä»£ç ç›®å½•: ${DFM_SOURCE_DIR}")
message(STATUS "æµ‹è¯•ç›®å½•: ${CMAKE_CURRENT_SOURCE_DIR}")
message(STATUS "æ„å»ºç›®å½•: ${CMAKE_BINARY_DIR}")
message(STATUS "========================================")

# Qt6é…ç½®
set(CMAKE_AUTOMOC ON)
set(CMAKE_AUTORCC ON)
set(CMAKE_AUTOUIC ON)

# æŸ¥æ‰¾å¿…è¦çš„ä¾èµ–
find_package(QT NAMES Qt6 Qt5 REQUIRED COMPONENTS Core)
find_package(Qt${QT_VERSION_MAJOR} REQUIRED COMPONENTS 
    Core 
    Test 
    Widgets
    Concurrent
    DBus
)

# æŸ¥æ‰¾Google Test
find_package(GTest REQUIRED)
if(GTest_FOUND)
    message(STATUS "âœ… Google Test æ‰¾åˆ°: ${GTEST_VERSION}")
else()
    message(FATAL_ERROR "âŒ Google Test æœªæ‰¾åˆ°ï¼Œè¯·å®‰è£… libgtest-dev")
endif()

# æŸ¥æ‰¾PkgConfigï¼ˆç”¨äºDtkä¾èµ–ï¼‰
find_package(PkgConfig REQUIRED)
if(PkgConfig_FOUND)
    message(STATUS "âœ… PkgConfig æ‰¾åˆ°")
else()
    message(FATAL_ERROR "âŒ PkgConfig æœªæ‰¾åˆ°")
endif()

# æŸ¥æ‰¾è¦†ç›–ç‡å·¥å…·
find_program(LCOV_PATH lcov)
find_program(GENHTML_PATH genhtml)
if(LCOV_PATH AND GENHTML_PATH)
    message(STATUS "âœ… è¦†ç›–ç‡å·¥å…·æ‰¾åˆ°: lcov, genhtml")
else()
    message(WARNING "âš ï¸  è¦†ç›–ç‡å·¥å…·æœªå®Œå…¨æ‰¾åˆ°ï¼ŒæŸäº›åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨")
    message(STATUS "   å®‰è£…å‘½ä»¤: sudo apt-get install lcov")
endif()

# æ·»åŠ ç¼–è¯‘å®šä¹‰
add_definitions(-DQT_MESSAGELOGCONTEXT)

# è®¾ç½®ç¼–è¯‘é€‰é¡¹
if(CMAKE_BUILD_TYPE STREQUAL "Debug")
    # Debugæ¨¡å¼ï¼šå¯ç”¨æ‰€æœ‰è°ƒè¯•å’Œè¦†ç›–ç‡é€‰é¡¹
    add_compile_options(
        -g                          # è°ƒè¯•ä¿¡æ¯
        -O0                         # ç¦ç”¨ä¼˜åŒ–
        -fprofile-arcs              # gcovè¦†ç›–ç‡æ•°æ®ç”Ÿæˆ
        -ftest-coverage             # æµ‹è¯•è¦†ç›–ç‡æ”¯æŒ
        -fno-access-control         # è®¿é—®ç§æœ‰æˆå‘˜ï¼ˆç”¨äºç™½ç›’æµ‹è¯•ï¼‰
        --coverage                  # è¦†ç›–ç‡æ”¯æŒ
    )
    
    # é“¾æ¥å™¨é€‰é¡¹
    add_link_options(
        --coverage                  # è¦†ç›–ç‡æ”¯æŒ
    )
    
    message(STATUS "ğŸ“Š Debugæ¨¡å¼ï¼šå¯ç”¨è¦†ç›–ç‡å’Œè°ƒè¯•é€‰é¡¹")
    
    # å¯é€‰ï¼šå¯ç”¨Address Sanitizerï¼ˆéœ€è¦æ—¶å–æ¶ˆæ³¨é‡Šï¼‰
    # add_compile_options(-fsanitize=address,undefined,leak)
    # add_link_options(-fsanitize=address,undefined,leak)
    
else()
    # Releaseæ¨¡å¼ï¼šä¼˜åŒ–ä½†ä¿ç•™è°ƒè¯•ä¿¡æ¯
    add_compile_options(-O2 -g)
    message(STATUS "ğŸš€ Releaseæ¨¡å¼ï¼šå¯ç”¨ä¼˜åŒ–")
endif()

# åŒ…å«æµ‹è¯•å·¥å…·æ¨¡å—
include(cmake/DFMTestUtils.cmake)
include(cmake/TestDiscovery.cmake)
include(cmake/CoverageTargets.cmake)

# è®¾ç½®CTest
enable_testing()

# è°ƒç”¨æµ‹è¯•å‘ç°å‡½æ•°
dfm_discover_tests()

# è®¾ç½®è¦†ç›–ç‡ç›®æ ‡
if(LCOV_PATH AND GENHTML_PATH)
    dfm_setup_coverage_targets()
endif()

# æ·»åŠ ä¾¿åˆ©ç›®æ ‡
add_custom_target(build-tests
    COMMENT "æ„å»ºæ‰€æœ‰æµ‹è¯•..."
)

add_custom_target(run-tests
    COMMAND ${CMAKE_CTEST_COMMAND} --output-on-failure
    COMMENT "è¿è¡Œæ‰€æœ‰æµ‹è¯•..."
)

add_custom_target(test-help
    COMMAND echo "å¯ç”¨çš„æµ‹è¯•ç›®æ ‡:"
    COMMAND echo "  make build-tests     - æ„å»ºæ‰€æœ‰æµ‹è¯•"
    COMMAND echo "  make run-tests       - è¿è¡Œæ‰€æœ‰æµ‹è¯•"
    COMMAND echo "  make coverage-all    - ç”Ÿæˆå®Œæ•´è¦†ç›–ç‡æŠ¥å‘Š"
    COMMAND echo "  make coverage-summary - æ˜¾ç¤ºè¦†ç›–ç‡æ‘˜è¦"
    COMMAND echo "  make clean-coverage  - æ¸…ç†è¦†ç›–ç‡æ•°æ®"
    COMMAND echo ""
    COMMAND echo "ç»„ä»¶ç‰¹å®šç›®æ ‡:"
    COMMAND echo "  make coverage-dfm-framework - dfm-frameworkè¦†ç›–ç‡"
    COMMAND echo "  make show-coverage-dfm-framework - æ˜¾ç¤ºæŠ¥å‘Šä½ç½®"
    COMMENT "æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯"
)

message(STATUS "")
message(STATUS "ğŸ¯ æµ‹è¯•ç³»ç»Ÿé…ç½®å®Œæˆï¼")
message(STATUS "   è¿è¡Œ 'make test-help' æŸ¥çœ‹å¯ç”¨å‘½ä»¤")
message(STATUS "   è¿è¡Œ 'make run-tests' æ‰§è¡Œæ‰€æœ‰æµ‹è¯•")
message(STATUS "   è¿è¡Œ 'make coverage-all' ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š")
message(STATUS "========================================")
message(STATUS "")
